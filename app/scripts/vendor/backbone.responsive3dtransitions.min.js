/*!
 * backbone.responsive3dtransitions v0.1.0
 * git://github.com/techjacker/Backbone-Responsive-3d-Page-Transitions.git
 *
 * Demos: http://projects.andrewgriffithsonline.com/#backbone-responsive-3d-page-transitions
 * Documentation: https://github.com/techjacker/Backbone-Responsive-3d-Page-Transitions
 *
 * Copyright 2012, Andrew Griffiths
 * Released under a MIT license
 *
 * Date: 2012-10-29
 */
(function(e,t){"use strict";typeof define=="function"&&define.amd?define(["backbone"],t):e.backboneResponsive3dTransitions=t(e.Backbone)})(this,function(e){"use strict";var t=function(t){_(this).bindAll("pageTransitionAnimation","calculateDirection","triggerTransition","resetCssOutmostDiv","calculateCssOutmostDiv","clearUpAfterTransition"),t&&(this.wrapElement=t.wrapElement,this.renderCallback=t.renderCallback),this.callBackCounter=0,this.threeDEnabled=this.csstransforms3d(),this.domSetUp(),e.Router.apply(this,[t])};return _.extend(t.prototype,e.Router.prototype,{calculateCssOutmostDiv:function(e,t,n){e instanceof jQuery||(e=$(this.wrapElement));if(!e.size())return;parseInt(t,10)||(t=parseInt($(window).width(),10));var r=parseInt(e.css("width"),10),i=parseInt(e.css("margin-right"),10),s=parseInt(e.css("margin-left"),10),o=parseInt(e.css("min-width"),10),u=parseInt(e.css("max-width"),10);return!i&&!s&&t!==r&&(i=s=Math.abs((t-r)/2)),this.trigger("threeDTrans.calculatedCssOutmostDiv"),n===!0?this.cssOutmostDiv={width:r/t*100+"%","margin-right":i/t*100+"%","margin-left":s/t*100+"%","min-width":o,"max-width":u}:this.cssOutmostDiv={width:r,"margin-right":i,"margin-left":s,"min-width":o,"max-width":u},this.cssOutmostDiv},resetCssOutmostDiv:function(){this.$outmostContainer.css({width:"","margin-right":"","margin-left":"","min-width":"","max-width":""})},domSetUp:function(){var e,t;this.wrapElement&&(e=$(this.wrapElement)).size()&&(e.wrap('<div class="threeDTrans-page-container" />'),e.parent().wrap('<div id="threeDTrans-inner-page-container" />'),e.parent().parent().wrap('<div class="threeDTrans-outer-page-container" />'),e.parent().parent().parent().wrap('<div class="threeDTrans-outmost-page-container" />')),this.$outmostContainer=$(".threeDTrans-outmost-page-container"),this.$outerContainer=this.$outmostContainer.children(".threeDTrans-outer-page-container"),this.$innerContainer=this.$outerContainer.children("#threeDTrans-inner-page-container"),this.$container=this.$innerContainer.children(".threeDTrans-page-container"),this.hasContainersNeeded=_.all([this.$outerContainer,this.$innerContainer,this.$container],function(e){return $(e).size()})},removeTrailingSlashes:function(e){return e=e.charAt(0)==="#"?e.slice(1):e,e.replace(/\/+$/,"")},pageTransitionAnimation:function(e,t,n){return this.disableLinks(this.newView),this.$outmostContainer.css(this.calculateCssOutmostDiv()),this.$outmostContainer.addClass("threeDTrans"),t.css("height",$(window).height()-20),t.addClass("threeDTrans-inner-page-container threeDTrans-outer-page-"+e),n.on("transitionend.threeDTrans mozTransitionEnd.threeDTrans webkitTransitionEnd.threeDTrans oTransitionEnd.threeDTrans MSTransitionEnd.threeDTrans",_.bind(this.pageTransitionCallback,this)),n.addClass("threeDTrans-animate-transform"),setTimeout(function(){n.addClass("threeDTrans-animate-"+e)},50),!0},pageTransitionCallback:function(e){var t=$(e.currentTarget),n=t.find(".threeDTrans-page");this.callBackCounter++===1&&n.size()===2&&(e.type==="transitionend"&&window.setTimeout(this.clearUpAfterTransition,500,t)||this.clearUpAfterTransition(t))},clearUpAfterTransition:function(e){e.off(".threeDTrans"),e.removeClass("threeDTrans-animate-transform"),e.parent("#threeDTrans-inner-page-container").removeClass("threeDTrans-inner-page-container threeDTrans-outer-page-backwards threeDTrans-outer-page-forwards").css("height",""),e.removeClass("threeDTrans-animate-forwards threeDTrans-animate-backwards"),this.disposeView(this.prevView),this.$outmostContainer.removeClass("threeDTrans"),this.resetCssOutmostDiv(),this.trigger("threeDTrans.pageTransitionComplete"),this.callBackCounter=0,this.enableLinks(this.newView),this.pageTransInProgress=!1},disposeView:function(e){if(!e)return!1;_.isFunction(e.dispose)?e.dispose():(e.unbind(),e.remove())},insertNewPage:{forwards:function(){var e=this;return e.$container.append(e.newView.el),e.pageTransitionAnimation("forwards",e.$innerContainer,e.$container)},backwards:function(){var e=this;return e.$container.prepend(e.newView.el),e.pageTransitionAnimation("backwards",e.$innerContainer,e.$container)},"default":function(){var e=this;e.$container.html(e.newView.el),e.disposeView(e.prevView),this.pageTransInProgress=!1,this.callBackCounter=0,this.trigger("threeDTrans.pageTransitionComplete")}},disableLinks:function(e){setTimeout(function(){e.$("a").on("threeDTrans.click",function(e){e&&e.preventDefault()&&e.stopPropagation()})},50)},enableLinks:function(e){setTimeout(function(){e.$("a").off("threeDTrans.click")},50)},csstransforms3d:function(){var e=document.createElement("p"),t,n={WebkitTransform:"-webkit-transform",OTransform:"-o-transform",MSTransform:"-ms-transform",MozTransform:"-moz-transform",Transform:"transform"};document.body.insertBefore(e,null);for(var r in n)e.style[r]!==undefined&&(e.style[r]="translate3d(1px,1px,1px)",t=window.getComputedStyle(e).getPropertyValue(n[r]));return document.body.removeChild(e),t!==undefined&&t.length>0&&t!=="none"},calculateDirection:function(e,t,n){var r=_.bind(function(e){return e=e&&e.replace(this.defaultView,""),e&&e.length?e.split("/").length:0},this),i,s,o="default";if(!this.initialLoad&&this.threeDEnabled&&this.hasContainersNeeded){if(n&&_.has(this.insertNewPage,n))return n;_.isString(e)&&(t=t||this.prevView&&this.prevView.hash||"",i=r(e),s=r(t),i!==s&&(o=i>s?"forwards":"backwards"))}return this.direction=o},triggerTransition:function(e,t){var n,r,i,s;if(this.pageTransInProgress===!0||this.callBackCounter!==0)return!1;this.pageTransInProgress=!0,this.callBackCounter=1,t&&(s=t.renderParams,r=_.isObject(t.viewInitOpts)&&t.viewInitOpts,i=t.direction),this.prevView=this.newView,this.initialLoad=!_.isObject(this.prevView),this.newView=new e(r),this.newView.hash||(this.newView.hash=this.removeTrailingSlashes(window.location.hash)),this.newView.render(s),this.newView.$el.addClass("threeDTrans-no-margin-width"),n=_.bind(function(){this.newView.$el.hasClass("threeDTrans-page")||this.newView.$el.addClass("threeDTrans-page"),_.bind(this.insertNewPage[this.calculateDirection(this.newView.hash,null,i)],this)()},this),this.renderCallback&&this.newView.on("render",n)||n()}}),t.extend=e.Router.extend,t});